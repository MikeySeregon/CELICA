# Migración: Soporte para Múltiples Camiones por Cotización

## Resumen de Cambios

Este documento describe los cambios de base de datos necesarios para implementar el soporte de **múltiples camiones con servicios independientes** por cotización, reemplazando el modelo anterior de un único camión por cotización.

---

## 1. Tabla `cotizaciones` - Cambios Opcionales

La tabla **no requiere cambios obligatorios** ya que:
- Los campos `id_camion` y `camion` ya existen como **opcionales** (cuando se crea cotización nueva, no se rellena).
- **Compatibilidad**: Si necesita mantener el legado (cotizaciones antiguas con `id_camion`/`camion`), dejarlos NULLABLE es suficiente.

### Si desea limpiar (OPCIONAL):

```sql
-- OPCIONAL: Marcar campos como obsoletos
-- En la aplicación, ya no se usan al guardar cotizaciones nuevas

-- Si algún script externo aún busca estos campos, dejarlos NULL
-- ALTER TABLE cotizaciones SET id_camion = NULL, camion = NULL;
```

---

## 2. Tabla `cotizacion_camiones` - YA EXISTE

```sql
-- Verificar que la tabla exista (debe estar creada ya)
SELECT * FROM cotizacion_camiones LIMIT 1;
```

Si no existe, crear:

```sql
CREATE TABLE IF NOT EXISTS public.cotizacion_camiones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  id_cotizacion BIGINT NOT NULL REFERENCES cotizaciones(id_cotizacion) ON DELETE CASCADE,
  id_camion BIGINT NOT NULL REFERENCES camiones(id_camion),
  camion TEXT NULL,
  orden INTEGER NOT NULL,
  CONSTRAINT uk_cotcamion_cot_ord UNIQUE (id_cotizacion, orden)
);
```

---

## 3. Tabla `cotizacion_detalle` - Verificar & Actualizar

La tabla ya debe existir con la columna `id_cotizacion_camion`, pero cree índices para optimizar:

```sql
-- PASO 1: Verificar que la tabla existe y tiene la columna
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'cotizacion_detalle' AND column_name = 'id_cotizacion_camion';

-- Si devuelve resultado: columna ya existe ✓
-- Si NO devuelve nada: ejecute (agregue la columna):
--  ALTER TABLE cotizacion_detalle ADD COLUMN id_cotizacion_camion BIGINT REFERENCES cotizacion_camiones(id);
```

---

## 4. Optimización: Crear Índices

```sql
-- PASO 2: Crear índices para búsquedas rápidas

-- Índice para buscar detalle por cotizacion_camion
CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_cot_camion 
  ON cotizacion_detalle(id_cotizacion_camion);

-- Índice para buscar camiones por cotizacion
CREATE INDEX IF NOT EXISTS ix_cotizacion_camiones_id_cotizacion 
  ON cotizacion_camiones(id_cotizacion);

-- Índice para búsquedas de detalles por cotizacion
CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_cotizacion 
  ON cotizacion_detalle(id_cotizacion);

-- Índice para servicios en detalles
CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_servicio 
  ON cotizacion_detalle(id_servicio);
```

---

## 5. (OPCIONAL) Agregar Constraint de Orden Único

Si desea garantizar que no haya dos camiones con el mismo orden en una cotización:

```sql
-- PASO 3: Constraint opcional para orden único por cotización
ALTER TABLE cotizacion_camiones 
ADD CONSTRAINT uk_cotcamion_cot_ord UNIQUE (id_cotizacion, orden);
-- (Puede fallar si ya existe, eso está bien)
```

---

## Orden de Ejecución SQL

Copie y ejecute en **pgAdmin** (o por CLI) en este orden:

```sql
-- 1. Verificar/crear cotizacion_camiones (si falta)
CREATE TABLE IF NOT EXISTS public.cotizacion_camiones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  id_cotizacion BIGINT NOT NULL REFERENCES cotizaciones(id_cotizacion) ON DELETE CASCADE,
  id_camion BIGINT NOT NULL REFERENCES camiones(id_camion),
  camion TEXT NULL,
  orden INTEGER NOT NULL
);

-- 2. Crear índices
CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_cot_camion 
  ON cotizacion_detalle(id_cotizacion_camion);

CREATE INDEX IF NOT EXISTS ix_cotizacion_camiones_id_cotizacion 
  ON cotizacion_camiones(id_cotizacion);

CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_cotizacion 
  ON cotizacion_detalle(id_cotizacion);

CREATE INDEX IF NOT EXISTS ix_cotizacion_detalle_id_servicio 
  ON cotizacion_detalle(id_servicio);

-- 3. (Opcional) Constraint de orden único
ALTER TABLE cotizacion_camiones 
ADD CONSTRAINT uk_cotcamion_cot_ord UNIQUE (id_cotizacion, orden);
```

---

## Cambios en la Aplicación (Frontend)

### HTML (`public/cotizaciones.html`)
- ✅ Añadido botón `#btnAgregarCamion`
- ✅ Reemplazada tabla única por `#camionesContainer` (genera dinámicamente una tabla por camión)

### JavaScript (`assets/js/cotizaciones.js`)
- ✅ Nueva estructura: `cotizacion.camiones[]` (cada camión contiene sus `lineas[]`)
- ✅ `contarLineasTotales()`: enforza límite de 12 líneas por cotización
- ✅ `guardarDetallePorCamiones()`: sincroniza `cotizacion_camiones` + `cotizacion_detalle` por camión
- ✅ `renderCamionesUI()`: genera tarjeta (card) por camión con tabla de servicios
- ✅ Recálculo de totales suma todas las líneas (camiones + servicios)

---

## Modelo de Datos Nuevo

### Estructura en Memoria (Frontend)

```javascript
cotizacion = {
  id_cotizacion: 123,
  fecha: '2026-02-08',
  estado: 7,
  cliente: { id_cliente, nombre, ... },
  camiones: [
    {
      id: null,              // id_cotizacion_camiones.id (null si no guardado)
      id_camion: 5,          // referencia a camiones.id_camion
      camion: "Volvo FM",
      orden: 1,
      lineas: [
        { es_camion: true, ... },  // línea camión (descripción)
        { id_servicio: 10, cantidad: 2, precio_unitario: 100, total_linea: 200, ... },
        { id_servicio: 15, cantidad: 1, precio_unitario: 50, total_linea: 50, ... }
      ]
    },
    {
      id: null,
      id_camion: 7,
      camion: "Hino 300",
      orden: 2,
      lineas: [
        { es_camion: true, ... },
        { id_servicio: 12, cantidad: 3, precio_unitario: 80, total_linea: 240, ... }
      ]
    }
  ],
  totales: { subtotal: 490, isv: 73.5, total: 563.5 }
}
```

### Persistencia en BD

| Tabla | Uso |
|-------|-----|
| `cotizaciones` | Cabecera (cliente, totales, estado, fecha) |
| `cotizacion_camiones` | 1 fila por camión (id_camion, orden) |
| `cotizacion_detalle` | N filas por camión: 1 con `id_servicio=NULL` (camión) + N servicios |

---

## Flujo de Guardado

1. **Crear cotización nueva** → Inserta en `cotizaciones` → Obtiene `id_cotizacion`
2. **Guardar cada camión** → Inserta/actualiza en `cotizacion_camiones` → Obtiene `id`
3. **Guardar servicios por camión** → Inserta/actualiza en `cotizacion_detalle` con `id_cotizacion_camion`
4. **Borrar camiones/servicios** → Elimina filas en `cotizacion_detalle` + `cotizacion_camiones`

---

## Límites y Validaciones

- **Máximo 12 líneas por cotización**: incluye líneas-camión + servicios
  - Ej: 3 camiones (3 líneas) + 9 servicios = 12 líneas ✓
- **Servicios únicos por camión**: no se puede repetir el mismo servicio en un camión
- **Camiones únicos por cotización**: no se puede agregar el mismo camión 2 veces

---

## PDF

La generación del PDF ordena las líneas por camión:
1. Línea de camión 1 (descripción centrada)
2. N servicios del camión 1
3. Línea de camión 2
4. N servicios del camión 2
5. ...

---

## Rollback (si es necesario)

Si necesita revertir a estructura anterior (1 camión por cotización):

```sql
-- Exportar datos nuevos a tabla temporal
CREATE TEMP TABLE cot_backup AS
SELECT cc.id_cotizacion, cc.id_camion, cc.camion, cd.id_servicio, 
       cd.descripcion_servicio, cd.cantidad, cd.precio_unitario, cd.total_linea
FROM cotizacion_camiones cc
LEFT JOIN cotizacion_detalle cd ON cd.id_cotizacion_camion = cc.id;

-- Borrar datos nuevos
DELETE FROM cotizacion_camiones;
DELETE FROM cotizacion_detalle WHERE id_cotizacion_camion IS NOT NULL;

-- Restaurar estructura antigua (si aplica)
-- UPDATE cotizaciones SET id_camion = cc.id_camion, camion = cc.camion FROM cot_backup cc ...
```

---

## Contacto & Soporte

Para dudas o problemas con la migración, verifique:
1. Que todas las tablas existan (consulta anterior)
2. Que los índices se crearon (check en pgAdmin)
3. Que la aplicación frontend se recargó después de los cambios JS

